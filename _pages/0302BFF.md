# 3.2 BFF安全框架

### 3.2.1 什么是BFF安全框架

　&emsp;BFF，即 Backend For Frontend（服务于前端的后端）。

BFF安全框架如下：

![image-20220622184401887](../image/image-20220622184401887.png ':size=75%')

> JavaScript代码从动态应用服务器(A)加载，该服务器本身也具有执行代码的能力。这使得能够将获取访问令牌所涉及的所有步骤保留在JavaScript应用程序之外。
>
> 注意，这个应用程序后端不是资源服务器，它仍然被认为是OAuth客户机的一部分，并且将在一个单独的资源服务器上访问数据。
>
> 在这种情况下，应用服务器通过将浏览器重定向到授权端点(B)来启动OAuth流。当用户被重定向回来时，浏览器将授权码传递给应用服务器(C ),然后它可以在令牌端点(D)使用其客户端机密将其交换为访问令牌。
> 然后，应用服务器将访问令牌和刷新令牌存储在内部，并通过传统的浏览器cookie (E)与基于浏览器的应用程序创建单独的会话。
>
> 当浏览器中的JavaScript应用程序想要向资源服务器发出请求时，它改为向应用服务器发出请求(F)，应用服务器将使用访问令牌向资源服务器发出请求(G)，并将响应(H)转发回浏览器。
>
> (这种架构的常见例子是带有. NET后端的Angular前端，或者带有Spring Boot后端的React前端。)
>
> 应用服务器应被视为机密客户端，并发布其自己的客户端机密。应用服务器应该使用OAuth 2.0授权码授权和PKCE来发起对访问令牌的请求。
>
> 在这种情况下，浏览器和应用服务器之间的连接应该是由应用服务器提供的会话cookie。
>
> 在浏览器中运行的代码和这个应用服务器之间的连接的安全性被假定为利用浏览器级别的保护机制。

### 3.2.2 新渡-国密安全WEB网关配置BFF

新渡-国密安全WEB网关（GMSWG）内置BFF，可通过配置开启。

* 基本流程如下：

  ![image-20220622090209845](../image/bffliucheng.png ':size=75%')

* BFF工作原理如下

  ![image-20220622142839561](../image/bffyuanli.png ':size=75%')

  > 1. 当客户端（前端）需要认证用户时，调用网关的一个API端点(/api/login)来启动登录认证。
  > 2. 网关使用OpenID connect和Auth0对用户进行身份验证，并获取ID、访问令牌和刷新令牌。
  > 3. 网关将获取到的用户令牌存储在缓存中。
  > 4. 网关将加密的cookie发送给客户端（前端）。
  > 5. 当客户端（前端）需要调用API时，它将加密的cookie连同URL和数据一起传递给网关以调用API。
  > 6. 网关从缓存中检索访问令牌，将该令牌包含在授权头中，并调用API。
  > 7. 当API向网关返回响应时，网关同时会将这个API的响应转发回客户端（前端）。
  
* 配置页面如下：

  1. API资源配置界面：

     ![image-20220622090209845](../image/api.png ':size=75%')

  2. 前端UI资源配置界面:

     ![image-20220622090209845](../image/ui.png ':size=75%')



