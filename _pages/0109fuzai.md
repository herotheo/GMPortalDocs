# 1.9 双层负载均衡

### 产品指标

新渡-国密安全WEB网关负载均衡支持情况如下：

|   功能   | 客户端到网关 | 网关到后端服务器 |
| :------: | :----------: | :--------------: |
| 负载均衡 |     支持     |       支持       |

### 指标演示

### 1.9.1 客户端到网关

客户端到网关支持的负载均衡策略如下：

> * 轮询(roundrobin )：按顺序循环选择目的地。
> * 静态轮询(static-rr)：与"roundrobin "类似，区别是"roundrobin "支持动态修改权重，而"static-rr"不支持。
> * 最少连接数(leastconn)：在多个目的地之中，选择接收连接最少的目的地。
> * 源IP(source )：根据请求来源的IP地址进行Hash计算，得到目的地。同一个IP会一直访问同一目的地。
> * URL参数(url_param)：根据URL路径中参数进行转发，保证在目的地数量不变的情况下，同一用户请求分发到同一机器。
> * URL(url)：对部分或整体URI进行hash运算，再与目的地的总权重相除，最后转发到匹配的目的地上。
> * 请求头(hdr)：根据http头转发，如果不存在http头。则使用简单轮循。
> * 随机(random)：随机选择一个目的地。
> * rdp-cookie：对cookie做hash，相同cookie的请求会被路由到同一目的地上。

* 演示项目：配置客户端到网关的负载均衡

* 预期结果：使用客户端多次访问"新渡-国密安全WEB网关"，我们部署在服务器A和服务器B上的网关会依次与客户端建立通信，例如：第一次访问会与部署在服务器A上的网关建立通信，第二次访问则与部署在服务器B上的网关建立通信，第三次访问又会与部署在服务器A上的网关建立通信，以此类推。

* 演示过程：
  1. 开启客户端到网关的负载均衡功能，并配置使用的负载均衡算法为：轮询（roundrobin ），并将服务器A与服务器B的网关地址配置到负载均衡的地址当中。
  
  2. 接着我们使用"奇安信浏览器"访问"新渡-国密安全WEB网关"。
  
  3. 第一次访问，由图可以看到，此次访问了位于服务器A上的网关。
  
     ![image-20220620150236510](../image/qian_fuzai1.png ':size=75%')
  
  4. 接着我们重新打开一个浏览器窗口，进行第二次访问，由图可见，这次访问了位于服务器B上的网关。
  
     ![image-20220620150438725](../image/qian_fuzai2.png ':size=75%')
  
  5. 通过上面可以看出，客户端到网关成功进行了轮询的负载均衡策略。

### 1.9.2 网关到后端服务器

新渡-国密安全WEB网关到后端服务器内置了负载均衡算法，也可针对需求对负载均衡算法进行扩展。

内置的负载均衡策略如下：

> * 字母顺序第一个(FirstAlphabetical)：选择按字母顺序排列的第一个可用目的地，不考虑负载。
> * 随机(Random)：随机选择一个目的地。
> * 两次随机选择(PowerOfTwoChoices)：随机选择两个目的地，然后选择处理请求最少的一个。
> * 轮询(RoundRobin)：按顺序循环选择目的地。
> * 最少请求(LeastRequests)：选择处理请求最少的目的地。


* 演示项目：配置网关到后端服务器的负载均衡

* 预期结果：使用客户端多次访问"新渡-国密安全WEB网关"，我们配置的后端服务器A和后端服务器B会按照顺序与客户端建立通信，例如：第一次访问会与后端服务器A建立通信，第二次访问则与后端服务器B建立通信，第三次访问又会与服务器A建立通信，以此类推。

* 演示过程：

  1. 我们以端口为5000的服务器作为我们的后端服务器A，以端口为5001的服务器作为我们的后端服务器B，然后开启网关到后端服务器的负载均衡功能，并将服务器A与服务器B的地址配置到负载均衡的地址中，并配置负载均衡策略为：轮询(RoundRobin)。

  2. 接着我们使用"奇安信浏览器"访问"新渡-国密安全WEB网关"。

  3. 第一次访问，由图可以看到，显示的是"我是后端端口为5001的服务器"（后端服务器A）。

     ![image-20220614162819693](../image/yarpfuzai5000.png ':size=75%')

  4. 接着我们重新打开一个浏览器窗口，进行第二次访问，由图可见这次显示的是"我是后端端口为5001的服务器"（后端服务器B）。

     ![image-20220614162913667](../image/yarpfuzai5001.png ':size=75%')

  5. 结合两次的访问结果可以看出，我们配置的负载均衡已生效。

至此，"新渡-国密安全WEB网关"负载均衡功能演示完毕，结果与预期结果相同。